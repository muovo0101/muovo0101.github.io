<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Player</title>

  <style>
    /* =========================
       UI：做成手机端友好的卡片
       ========================= */
    :root{
      --bg1:#ffb3c7;
      --bg2:#b9b3ff;
      --card:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.18);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --accent:#ff6aa2;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .player{
      width:min(520px,100%);
      border-radius:18px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:0 18px 45px rgba(0,0,0,.35);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      overflow:hidden;
    }
    .head{
      padding:16px;
      display:flex;
      gap:14px;
      align-items:center;
      background:rgba(255,255,255,.06);
    }
    .cover{
      width:64px;height:64px;
      border-radius:14px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.15);
      flex:0 0 auto;
    }
    .meta{flex:1 1 auto; min-width:0;}
    .title{
      margin:0;
      font-size:18px;
      font-weight:900;
      color:var(--text);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .controls{padding:14px 16px 12px;}
    .progress-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .time{
      width:46px;
      text-align:center;
      font-variant-numeric:tabular-nums;
      font-size:12px;
      color:var(--muted);
    }
    input[type=range]{
      flex:1;
      height:4px;
      accent-color:var(--accent);
    }
    .btn-row{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin-bottom:10px;
    }
    button{
      border:0;
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.16);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    button:active{transform:scale(.98);}
    .play{
      padding:10px 18px;
      background:rgba(255,106,162,.92);
      color:#fff;
    }
    .hint{
      padding:0 16px 14px;
      font-size:12px;
      color:var(--muted);
    }
    .list{
      border-top:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:8px 0;
    }
    .item{
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      gap:10px;
    }
    .item:hover{background:rgba(255,255,255,.08);}
    .item.active{background:rgba(255,106,162,.18); font-weight:900;}
    .item .name{
      color:var(--text);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .item small{color:var(--muted); font-weight:700; flex:0 0 auto;}

    /* 歌词 */
    .lrc{
      padding:12px 16px 16px;
      border-top:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      max-height:180px;
      overflow:auto;
    }
    .lrc p{
      margin:8px 0;
      color:rgba(255,255,255,.68);
      font-size:13px;
      line-height:1.5;
    }
    .lrc p.active{
      color:rgba(255,255,255,.95);
      font-weight:900;
    }
  </style>
</head>

<body>
  <div class="player">
    <div class="head">
      <!-- 封面：从 music.json 的 cover 字段读取 -->
      <img class="cover" id="cover" alt="cover" />
      <div class="meta">
        <h1 class="title" id="nowTitle">正在加载歌单...</h1>
        <div class="sub" id="nowSub">来源：GitHub Pages /music/</div>
      </div>
    </div>

    <div class="controls">
      <div class="progress-row">
        <div class="time" id="curTime">0:00</div>
        <input id="progress" type="range" min="0" max="1000" value="0" />
        <div class="time" id="durTime">0:00</div>
      </div>

      <div class="btn-row">
        <button id="prevBtn">⏮ 上一首</button>
        <button class="play" id="playBtn">▶ 播放</button>
        <button id="nextBtn">下一首 ⏭</button>
      </div>

      <div class="hint" id="hint">提示：如果列表不显示，请直接打开 music.json 看是否是纯 JSON。</div>
    </div>

    <div class="list" id="list"></div>

    <div class="lrc" id="lrcBox">
      <p>歌词区：如果没有 lrc 文件也没关系。</p>
    </div>
  </div>

  <!-- 真正负责播放的音频标签 -->
  <audio id="audio" preload="metadata"></audio>

  <script>
    /* =========================
       1) 固定资源根目录（跟他一样：同站点相对路径）
       ========================= */
    const BASE = location.origin + "/music/";            // 例如：https://muovo0101.github.io/music/
    const PLAYLIST_URL = BASE + "music.json";           // 例如：https://muovo0101.github.io/music/music.json

    /* =========================
       2) DOM 引用
       ========================= */
    const audio = document.getElementById("audio");
    const coverEl = document.getElementById("cover");
    const nowTitle = document.getElementById("nowTitle");
    const nowSub = document.getElementById("nowSub");
    const hintEl = document.getElementById("hint");
    const listEl = document.getElementById("list");
    const lrcBox = document.getElementById("lrcBox");

    const playBtn = document.getElementById("playBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const progress = document.getElementById("progress");
    const curTimeEl = document.getElementById("curTime");
    const durTimeEl = document.getElementById("durTime");

    /* =========================
       3) 播放列表与状态
       ========================= */
    let playlist = [];          // music.json 读到的数组
    let currentIndex = 0;       // 当前播放下标

    /* 歌词解析结果：[{t:秒, text:"..."}] */
    let lrcLines = [];

    /* =========================
       4) 工具：格式化时间 mm:ss
       ========================= */
    function formatTime(sec) {
      if (!Number.isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return m + ":" + String(s).padStart(2, "0");
    }

    /* =========================
       5) 渲染列表
       ========================= */
    function renderList() {
      listEl.innerHTML = "";
      playlist.forEach((song, idx) => {
        const div = document.createElement("div");
        div.className = "item" + (idx === currentIndex ? " active" : "");
        div.innerHTML =
          `<div class="name">${song.title || ("歌曲 " + (idx + 1))}</div>` +
          `<small>${idx === currentIndex ? "正在播放" : "点击播放"}</small>`;
        div.addEventListener("click", () => loadSong(idx, true));
        listEl.appendChild(div);
      });
    }

    /* =========================
       6) 解析 LRC（简单版）
       例：[01:23.45]歌词
       ========================= */
    function parseLrc(text) {
      const out = [];
      const lines = text.split(/\r?\n/);
      for (const line of lines) {
        const m = line.match(/\[(\d+):(\d+)(?:\.(\d+))?\](.*)/);
        if (!m) continue;

        const min = Number(m[1]);
        const sec = Number(m[2]);
        const ms = m[3] ? Number(("0." + m[3])) : 0;
        const lyric = (m[4] || "").trim();

        const t = min * 60 + sec + ms;
        if (lyric) out.push({ t, text: lyric });
      }
      out.sort((a, b) => a.t - b.t);
      return out;
    }

    /* =========================
       7) 渲染歌词
       ========================= */
    function renderLrc(activeIndex) {
      if (!lrcLines.length) {
        lrcBox.innerHTML = "<p>没有歌词（或 lrc 文件不存在）。</p>";
        return;
      }
      lrcBox.innerHTML = "";
      lrcLines.forEach((line, i) => {
        const p = document.createElement("p");
        p.textContent = line.text;
        if (i === activeIndex) p.className = "active";
        lrcBox.appendChild(p);
      });

      /* 让当前行尽量滚到中间（体验更像他那种播放器） */
      const activeP = lrcBox.querySelector("p.active");
      if (activeP) {
        const top = activeP.offsetTop - lrcBox.clientHeight / 2 + activeP.clientHeight;
        lrcBox.scrollTo({ top: Math.max(top, 0), behavior: "smooth" });
      }
    }

    /* =========================
       8) 根据当前播放时间，定位歌词行
       ========================= */
    function syncLrcByTime(currentSec) {
      if (!lrcLines.length) return;
      let i = 0;
      for (; i < lrcLines.length; i++) {
        if (lrcLines[i].t > currentSec) break;
      }
      const active = Math.max(i - 1, 0);
      renderLrc(active);
    }

    /* =========================
       9) 加载某一首歌（跟他一样：file/cover/lrc 都从 json 来）
       ========================= */
    async function loadSong(index, autoPlay) {
      if (!playlist.length) return;

      currentIndex = (index + playlist.length) % playlist.length;
      const song = playlist[currentIndex];

      /* 标题与副标题 */
      nowTitle.textContent = song.title || ("歌曲 " + (currentIndex + 1));
      nowSub.textContent = (song.artist ? (song.artist + " · ") : "") + "资源：" + BASE;

      /* 关键：拼出真实资源 URL（跟他一样：BASE + 相对路径） */
      audio.src = BASE + (song.file || "");

      /* 封面（可选，没有就留空） */
      coverEl.src = song.cover ? (BASE + song.cover) : "";

      /* 进度显示重置 */
      progress.value = 0;
      curTimeEl.textContent = "0:00";
      durTimeEl.textContent = "0:00";

      /* 列表高亮 */
      renderList();

      /* 歌词加载（可选） */
      lrcLines = [];
      if (song.lrc) {
        try {
          const res = await fetch(BASE + song.lrc + "?t=" + Date.now(), { cache: "no-store" });
          if (res.ok) {
            const txt = await res.text();
            lrcLines = parseLrc(txt);
          }
        } catch (e) {}
      }
      renderLrc(0);

      /* 是否自动播放 */
      if (autoPlay) {
        try {
          await audio.play();
          playBtn.textContent = "⏸ 暂停";
        } catch (e) {
          hintEl.textContent = "提示：浏览器可能拦截自动播放，请手动点播放。";
        }
      }
    }

    /* =========================
       10) 初始化：读取 music.json（跟他一样：fetch json）
       ========================= */
    async function init() {
      try {
        hintEl.textContent = "提示：正在请求 music.json ...";
        const res = await fetch(PLAYLIST_URL + "?t=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        if (!Array.isArray(data) || !data.length) throw new Error("music.json 必须是非空数组");
        if (!data[0].file) throw new Error("每首歌必须有 file 字段，例如 audio/song1.mp3");

        playlist = data;
        hintEl.textContent = "歌单加载成功 ✅ 点击列表或点播放";
        await loadSong(0, false);
      } catch (e) {
        nowTitle.textContent = "加载失败";
        hintEl.textContent = "失败原因：" + e.message + "；请直接打开 " + PLAYLIST_URL + " 检查。";
        console.log(e);
      }
    }

    /* =========================
       11) 事件：播放/暂停、切歌、进度条
       ========================= */
    playBtn.addEventListener("click", async () => {
      if (!audio.src && playlist.length) await loadSong(0, false);
      if (audio.paused) {
        try { await audio.play(); playBtn.textContent = "⏸ 暂停"; }
        catch (e) { hintEl.textContent = "播放失败：音频无法访问或格式不支持"; }
      } else {
        audio.pause();
        playBtn.textContent = "▶ 播放";
      }
    });

    prevBtn.addEventListener("click", () => loadSong(currentIndex - 1, true));
    nextBtn.addEventListener("click", () => loadSong(currentIndex + 1, true));

    audio.addEventListener("loadedmetadata", () => {
      durTimeEl.textContent = formatTime(audio.duration);
    });

    audio.addEventListener("timeupdate", () => {
      curTimeEl.textContent = formatTime(audio.currentTime);
      if (Number.isFinite(audio.duration) && audio.duration > 0) {
        progress.value = String(Math.floor((audio.currentTime / audio.duration) * 1000));
      }
      syncLrcByTime(audio.currentTime);
    });

    progress.addEventListener("input", () => {
      if (!Number.isFinite(audio.duration) || audio.duration <= 0) return;
      audio.currentTime = audio.duration * (Number(progress.value) / 1000);
    });

    audio.addEventListener("ended", () => loadSong(currentIndex + 1, true));

    /* 启动 */
    init();
  </script>
</body>
</html>
